<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBOR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --dark: #0a0f1a; --card-bg: #1e293b; }
        body { font-family: sans-serif; background: var(--dark); color: white; margin: 0; padding: 0; overflow: hidden; }
        #map { position: fixed; top: 0; width: 100%; height: 100%; z-index: 1; }
        .card { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); padding: 20px; border-radius: 25px 25px 0 0; z-index: 1000; box-sizing: border-box; max-height: 80vh; overflow-y: auto; }
        .step { display: none; } .step.active { display: block; }
        button { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--neon); color: black; font-weight: bold; margin: 8px 0; font-size: 16px; }
        button.sec { background: rgba(255,255,255,0.1); color: white; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 10px; box-sizing: border-box; }
        .summary { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; font-size: 14px; line-height: 1.6; border-left: 4px solid var(--neon); }
        .pin { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 500; font-size: 40px; pointer-events: none; display: none; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="pin" id="main-pin">üìç</div>

    <div class="card">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –Ø–∑—ã–∫</h2>
            <button onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="h-cat">–¢–∏–ø –∑–∞–∫–∞–∑–∞</h2>
            <button onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
        </div>

        <div id="step3" class="step">
            <h2 id="h-data">–î–∞–Ω–Ω—ã–µ</h2>
            <input type="text" id="inp-what" placeholder="–ß—Ç–æ –ø—Ä–∏–≤–µ–∑—Ç–∏? / Nima olib kelish kerak?">
            <input type="text" id="user-name" placeholder="–í–∞—à–µ –∏–º—è / Ismingiz">
            <input type="tel" id="user-phone" placeholder="+998">

            <div id="parcel-extra" style="display:none">
                <hr style="opacity:0.1">
                <input type="text" id="rec-name" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è / Kim oladi?">
                <input type="tel" id="rec-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
            </div>
            <button onclick="validateData()">–î–∞–ª–µ–µ / Keyingi</button>
        </div>

        <div id="step4" class="step">
            <h2 id="h-map">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ</h2>
            <button id="btn-from" onclick="startMap('from')">üìç –û—Ç–∫—É–¥–∞ (A)</button>
            <button id="btn-to" onclick="startMap('to')">üèÅ –ö—É–¥–∞ (B)</button>
            <button id="btn-map-confirm" style="display:none" onclick="go(5)">–ì–æ—Ç–æ–≤–æ / Tayyor</button>
        </div>

        <div id="step5" class="step">
            <h2 id="h-check">–ü—Ä–æ–≤–µ—Ä–∫–∞</h2>
            <div id="check-data" class="summary"></div>
            <button onclick="sendOrder()">‚úÖ –í—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ / Hammasi to'g'ri</button>
            <button class="sec" onclick="go(2)">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞–Ω–æ–≤–æ / Qaytadan</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let order = { lang:'ru', type:'', what:'', name:'', phone:'', rec_name:'-', rec_phone:'-', lat_from:0, lon_from:0, lat_to:0, lon_to:0, price:7000 };
        let map, mapMode = '';

        IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        function setLang(l) { order.lang = l; go(2); }
        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-extra').style.display = c === 'parcel' ? 'block' : 'none';
            go(3);
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + s).classList.add('active');
            document.getElementById('main-pin').style.display = 'none';
        }

        function validateData() {
            order.what = document.getElementById('inp-what').value;
            order.name = document.getElementById('user-name').value;
            order.phone = document.getElementById('user-phone').value;
            if(order.type === 'parcel') {
                order.rec_name = document.getElementById('rec-name').value;
                order.rec_phone = document.getElementById('rec-phone').value;
            }
            if(!order.what || !order.name || order.phone.length < 10) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            go(4);
        }

        function startMap(mode) {
            mapMode = mode;
            document.getElementById('main-pin').style.display = 'block';
            document.querySelectorAll('.step').forEach(el => el.style.display = 'none');

            // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–µ
            let confBtn = document.createElement('button');
            confBtn.id = 'temp-btn';
            confBtn.style.position = 'fixed'; confBtn.style.bottom = '20px'; confBtn.style.zIndex = '2000';
            confBtn.innerText = "üìç –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç–æ –º–µ—Å—Ç–æ";
            confBtn.onclick = () => {
                let center = map.getCenter();
                if(mapMode === 'from') { order.lat_from = center.lat; order.lon_from = center.lng; document.getElementById('btn-from').innerText = "‚úÖ A –≤—ã–±—Ä–∞–Ω–æ"; }
                else { order.lat_to = center.lat; order.lon_to = center.lng; document.getElementById('btn-to').innerText = "‚úÖ B –≤—ã–±—Ä–∞–Ω–æ"; }
                confBtn.remove();
                document.querySelectorAll('.step').forEach(el => el.style.display = '');
                go(4);
                if(order.lat_from && order.lat_to) document.getElementById('btn-map-confirm').style.display = 'block';
            };
            document.body.appendChild(confBtn);
        }

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([40.4897, 68.7848], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);
        }

        function showSummary() {
            let txt = `<b>–¢–∏–ø:</b> ${order.type === 'parcel' ? '–ü–æ—Å—ã–ª–∫–∞' : '–ü—Ä–æ–¥—É–∫—Ç—ã'}<br>` +
                      `<b>–ß—Ç–æ:</b> ${order.what}<br><b>–ò–º—è:</b> ${order.name}<br><b>–¢–µ–ª:</b> ${order.phone}`;
            if(order.type === 'parcel') txt += `<br><b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> ${order.rec_name} (${order.rec_phone})`;
            document.getElementById('check-data').innerHTML = txt;
        }

        function sendOrder() { tg.sendData(JSON.stringify(order)); }

        initMap();
        document.getElementById('btn-map-confirm').onclick = () => { showSummary(); go(5); };
    </script>
</body>
</html>