<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --yandex-bg: #f3f3f7; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #000; font-family: -apple-system, sans-serif;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã - —Ç–µ–ø–µ—Ä—å –æ–Ω –ø–æ–¥ –≤—Å–µ–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        #map {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; z-index: 1;
        }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∏–Ω Yandex Style */
        .center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 10; pointer-events: none; display: none;
            text-align: center;
        }
        .pin-icon { font-size: 45px; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ */
        .map-controls {
            position: absolute; right: 15px; top: 80px;
            display: flex; flex-direction: column; gap: 10px; z-index: 10;
        }
        .map-btn {
            background: white; width: 45px; height: 45px; border-radius: 12px;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 20px;
        }

        /* –ü–æ–∏—Å–∫ —Å–≤–µ—Ä—Ö—É */
        .search-container {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 90%; z-index: 20; display: none;
        }
        .search-input {
            width: 100%; padding: 14px 20px; border-radius: 15px; border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); font-size: 16px; outline: none;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ - –≤—Å–µ–≥–¥–∞ —Å–Ω–∏–∑—É */
        .card {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 25px 25px 0 0;
            z-index: 100; box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
            padding: 20px 20px 35px; box-sizing: border-box;
            max-height: 90vh; overflow-y: auto;
        }

        .step { display: none; }
        .step.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        h2 { font-size: 20px; font-weight: 700; margin: 0 0 15px; text-align: center; color: #222; }

        button {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            font-size: 16px; font-weight: 600; margin-bottom: 10px; cursor: pointer;
        }
        .btn-primary { background: var(--neon); color: #000; }
        .btn-secondary { background: var(--yandex-bg); color: #222; }

        input, select {
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #eee;
            background: var(--yandex-bg); margin-bottom: 10px; box-sizing: border-box; font-size: 16px;
        }

        .summary-box { background: var(--yandex-bg); padding: 15px; border-radius: 15px; margin-bottom: 15px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="search-container" id="search-box">
        <input type="text" class="search-input" placeholder="–ù–∞–π—Ç–∏ —É–ª–∏—Ü—É –≤ –ì—É–ª–∏—Å—Ç–∞–Ω–µ..." oninput="smartSearch(this.value)">
    </div>

    <div class="center-pin" id="main-pin">
        <div class="pin-icon">üìç</div>
    </div>

    <div class="map-controls">
        <div class="map-btn" id="loc-btn" onclick="findMe()">üéØ</div>
    </div>

    <div class="card">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –Ø–∑—ã–∫</h2>
            <button class="btn-primary" onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="btn-primary" onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="h-cat">–¢–∏–ø –∑–∞–∫–∞–∑–∞</h2>
            <button class="btn-primary" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button class="btn-primary" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="btn-secondary" onclick="go(1)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2>–î–µ—Ç–∞–ª–∏</h2>
            <input type="text" id="inp-what" placeholder="–ß—Ç–æ –≤–µ–∑–µ–º?">
            <input type="text" id="user-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="tel" id="user-phone">

            <div id="parcel-extra" style="display:none">
                <input type="text" id="rec-name" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
                <input type="tel" id="rec-phone">
            </div>

            <button class="btn-primary" onclick="validateStep3()">–î–∞–ª–µ–µ</button>
            <button class="btn-secondary" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2>–ú–∞—Ä—à—Ä—É—Ç</h2>
            <button id="b-from" class="btn-secondary" onclick="openMap('from')">üìç –û—Ç–∫—É–¥–∞</button>
            <button id="b-to" class="btn-secondary" onclick="openMap('to')">üèÅ –ö—É–¥–∞</button>
            <button id="b-done" class="btn-primary" style="display:none" onclick="go(5)">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
            <button class="btn-secondary" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step-confirm" class="step">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ</h2>
            <button class="btn-primary" onclick="savePoint()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–æ—á–∫—É</button>
            <button class="btn-secondary" onclick="go(4)">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div id="step5" class="step">
            <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞</h2>
            <div id="summary" class="summary-box"></div>
            <button class="btn-primary" onclick="finish()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨</button>
            <button class="btn-secondary" onclick="go(4)">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', lat_from:null, lat_to:null };
        let map, mapMode = '';

        const m1 = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        const m2 = IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([40.4897, 68.7848], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            let sid = (typeof s === 'string') ? 'step-'+s : 'step'+s;
            document.getElementById(sid).classList.add('active');

            const isConfirm = (s === 'confirm');
            document.getElementById('main-pin').style.display = isConfirm ? 'block' : 'none';
            document.getElementById('search-box').style.display = isConfirm ? 'block' : 'none';
            document.getElementById('loc-btn').style.display = isConfirm ? 'block' : 'none';
        }

        function setLang(l) { order.lang = l; go(2); }
        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-extra').style.display = c === 'parcel' ? 'block' : 'none';
            go(3);
        }

        function validateStep3() {
            if(!document.getElementById('user-name').value || m1.value.length < 18) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
            go(4);
        }

        function openMap(m) { mapMode = m; go('confirm'); }
        function findMe() { map.locate({setView: true, maxZoom: 16}); }

        function savePoint() {
            let c = map.getCenter();
            if(mapMode === 'from') {
                order.lat_from = c.lat; order.lon_from = c.lng;
                document.getElementById('b-from').innerText = "‚úÖ –û—Ç–∫—É–¥–∞: OK";
            } else {
                order.lat_to = c.lat; order.lon_to = c.lng;
                document.getElementById('b-to').innerText = "‚úÖ –ö—É–¥–∞: OK";
            }
            if(order.lat_from && order.lat_to) {
                document.getElementById('b-done').style.display = 'block';
                showSummary();
            }
            go(4);
        }

        function showSummary() {
            let res = `üì¶ <b>${order.type === 'parcel' ? '–ü–æ—Å—ã–ª–∫–∞' : '–ü—Ä–æ–¥—É–∫—Ç—ã'}</b><br>` +
                      `üë§ ${document.getElementById('user-name').value}<br>` +
                      `üìû ${m1.value}`;
            document.getElementById('summary').innerHTML = res;
        }

        function finish() {
            let data = {
                ...order,
                name: document.getElementById('user-name').value,
                phone: m1.value,
                what: document.getElementById('inp-what').value,
                rec_name: document.getElementById('rec-name').value || '-',
                rec_phone: m2.value || '-'
            };
            tg.sendData(JSON.stringify(data));
        }

        function smartSearch(val) {
            if(val.length < 3) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=–ì—É–ª–∏—Å—Ç–∞–Ω ${val}&limit=1`)
            .then(r => r.json()).then(res => { if(res[0]) map.panTo([res[0].lat, res[0].lon]); });
        }

        initMap();
    </script>
</body>
</html>