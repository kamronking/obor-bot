<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --yandex-bg: #f3f3f7; --dark-blue: #0f172a; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--dark-blue); font-family: -apple-system, sans-serif; color: white;
        }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† –ö–ê–†–¢–´ (–°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        #map-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; display: none; background: white;
        }
        #map { width: 100%; height: 100%; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç—ã */
        .map-ui { position: absolute; z-index: 2100; width: 100%; pointer-events: none; }
        .map-ui * { pointer-events: auto; }

        .search-bar { top: 15px; padding: 0 15px; box-sizing: border-box; }
        .search-bar input {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 16px;
        }

        .center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%); font-size: 40px;
        }

        .map-confirm-btn {
            bottom: 30px; padding: 0 20px;
        }

        /* –ì–õ–ê–í–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê (–ê–ù–ö–ï–¢–ê) */
        .app-container {
            padding: 20px; display: flex; flex-direction: column; min-height: 100vh;
            box-sizing: border-box;
        }

        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { font-size: 22px; margin-bottom: 20px; text-align: center; }

        button {
            width: 100%; padding: 18px; border-radius: 16px; border: none;
            font-size: 16px; font-weight: 700; margin-bottom: 12px; cursor: pointer;
            transition: 0.2s;
        }
        .btn-main { background: var(--neon); color: black; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; }
        .btn-map { background: #fff; color: #000; border: 1px solid #ddd; }

        input {
            width: 100%; padding: 16px; border-radius: 14px; border: 1px solid #334155;
            background: #1e293b; color: white; margin-bottom: 12px; box-sizing: border-box;
        }

        .summary { background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="map-overlay">
        <div class="map-ui search-bar">
            <input type="text" placeholder="–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã –≤ –ì—É–ª–∏—Å—Ç–∞–Ω–µ..." oninput="smartSearch(this.value)">
        </div>
        <div class="center-pin">üìç</div>
        <div id="map"></div>
        <div class="map-ui map-confirm-btn">
            <button class="btn-main" onclick="confirmPoint()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç–æ –º–µ—Å—Ç–æ</button>
            <button class="btn-sec" onclick="closeMap()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="app-container">

        <div id="step1" class="step active">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Til tanlang</h2>
            <button class="btn-main" onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="btn-main" onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2>–ß—Ç–æ –≤–µ–∑–µ–º?</h2>
            <button class="btn-main" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button class="btn-main" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="btn-sec" onclick="go(1)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2>–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞</h2>
            <input type="text" id="inp-what" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–µ–∑–µ–º?">
            <input type="text" id="user-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="tel" id="user-phone">

            <div id="parcel-extra" style="display:none">
                <hr style="opacity:0.1; margin: 15px 0;">
                <input type="text" id="rec-name" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
                <input type="tel" id="rec-phone">
            </div>

            <button class="btn-main" onclick="go(4)">–î–∞–ª–µ–µ</button>
            <button class="btn-sec" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2>–ú–∞—Ä—à—Ä—É—Ç</h2>
            <button id="b-from" class="btn-map" onclick="openMap('from')">üìç –û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å (A)</button>
            <button id="b-to" class="btn-map" onclick="openMap('to')">üèÅ –ö—É–¥–∞ –≤–µ–∑—Ç–∏ (B)</button>

            <div id="order-ready" style="display:none">
                <button class="btn-main" onclick="showSummary()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
            <button class="btn-sec" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step5" class="step">
            <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
            <div id="summary-info" class="summary"></div>
            <button class="btn-main" onclick="sendToBot()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨ –ö–£–†–¨–ï–†–£</button>
            <button class="btn-sec" onclick="go(4)">–ù–∞–∑–∞–¥</button>
        </div>

    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', lat_from:null, lat_to:null };
        let map, mapMode = '';

        const m1 = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        const m2 = IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([40.4897, 68.7848], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + s).classList.add('active');
        }

        function setLang(l) { order.lang = l; go(2); }
        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-extra').style.display = c === 'parcel' ? 'block' : 'none';
            go(3);
        }

        // –ö–ê–†–¢–ê
        function openMap(mode) {
            mapMode = mode;
            document.getElementById('map-overlay').style.display = 'block';
            if (!map) initMap();
            map.invalidateSize(); // –ß—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –ø—Ä–æ—Ä–∏—Å–æ–≤—ã–≤–∞–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        }

        function closeMap() {
            document.getElementById('map-overlay').style.display = 'none';
        }

        function confirmPoint() {
            let center = map.getCenter();
            if (mapMode === 'from') {
                order.lat_from = center.lat; order.lon_from = center.lng;
                document.getElementById('b-from').innerText = "‚úÖ A: –í—ã–±—Ä–∞–Ω–æ";
            } else {
                order.lat_to = center.lat; order.lon_to = center.lng;
                document.getElementById('b-to').innerText = "‚úÖ B: –í—ã–±—Ä–∞–Ω–æ";
            }

            if (order.lat_from && order.lat_to) {
                document.getElementById('order-ready').style.display = 'block';
            }
            closeMap();
        }

        function smartSearch(val) {
            if(val.length < 3) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=–ì—É–ª–∏—Å—Ç–∞–Ω ${val}&limit=1`)
            .then(r => r.json()).then(res => { if(res[0]) map.panTo([res[0].lat, res[0].lon]); });
        }

        // –§–ò–ù–ê–õ
        function showSummary() {
            let html = `<b>–¢–∏–ø:</b> ${order.type}<br><b>–ò–º—è:</b> ${document.getElementById('user-name').value}<br><b>–¢–µ–ª:</b> ${m1.value}`;
            document.getElementById('summary-info').innerHTML = html;
            go(5);
        }

        function sendToBot() {
            let data = {
                ...order,
                name: document.getElementById('user-name').value,
                phone: m1.value,
                what: document.getElementById('inp-what').value,
                rec_name: document.getElementById('rec-name').value || '-',
                rec_phone: m2.value || '-'
            };
            tg.sendData(JSON.stringify(data));
        }

        initMap(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª–æ –ø–æ—Ç–æ–º
    </script>
</body>
</html>