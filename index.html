<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --dark: #0a0f1a; --card-bg: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--dark); color: white; margin: 0; padding: 0; overflow: hidden; height: 100vh; }

        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π 3D –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: —Ç–µ–ø–µ—Ä—å –∫–∞—Ä—Ç–∞ –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è */
        #map-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            perspective: 1200px; background: var(--dark);
        }
        #map {
            width: 100%; height: 120%;
            transform: rotateX(20deg) translateY(-10%);
            transform-origin: bottom;
        }

        /* –ü–æ–∏—Å–∫: –≤—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—Ö—É */
        .search-container {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 90%; z-index: 2000; display: none;
        }
        .search-input {
            width: 100%; padding: 15px; border-radius: 14px; border: 2px solid var(--neon);
            font-size: 16px; outline: none; background: white; color: black;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #search-results { background: white; color: black; border-radius: 0 0 14px 14px; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∏–Ω–∞ */
        .center-marker {
            position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1500; pointer-events: none; font-size: 50px; display: none;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
        }

        /* –ö–Ω–æ–ø–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ */
        .locate-btn {
            position: absolute; top: 85px; right: 15px; z-index: 1500;
            background: white; color: black; border-radius: 12px; width: 50px; height: 50px;
            display: none; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
        .card {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); padding: 25px 20px 40px 20px;
            border-radius: 30px 30px 0 0; z-index: 1000;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8); box-sizing: border-box;
        }

        .step { display: none; }
        .step.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        h2 { font-size: 22px; margin: 0 0 20px 0; text-align: center; font-weight: 800; color: #fff; }

        /* –ö–Ω–æ–ø–∫–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏ */
        button {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            background: var(--neon); color: black; font-weight: 800; font-size: 17px;
            margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: 0.2s;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }
        button.sec { background: rgba(255,255,255,0.1); color: white; }

        input, select {
            width: 100%; padding: 16px; border-radius: 15px; border: 1px solid #334155;
            background: #0f172a; color: white; margin-bottom: 15px; box-sizing: border-box; font-size: 16px;
        }

        .summary-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--neon); }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <div class="search-container" id="search-box">
        <input type="text" class="search-input" id="addr-search" placeholder="Qidiruv / –ü–æ–∏—Å–∫..." oninput="searchAddress(this.value)">
        <div id="search-results"></div>
    </div>

    <div class="center-marker" id="main-pin">üìç</div>
    <div class="locate-btn" id="loc-btn" onclick="locateMe()">üéØ</div>

    <div class="card">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –Ø–∑—ã–∫</h2>
            <button onclick="applyLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button onclick="applyLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="h-cat">–¢–∏–ø –∑–∞–∫–∞–∑–∞</h2>
            <button onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="sec" onclick="go(1)">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
        </div>

        <div id="step-weight" class="step">
            <h2 id="h-weight">–í–µ—Å –ø–æ—Å—ã–ª–∫–∏</h2>
            <select id="inp-weight" onchange="calcPrice()">
                <option value="5">–î–æ 5 –∫–≥ (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                <option value="10">10 –∫–≥ (+10 000 —Å—É–º)</option>
                <option value="20">20 –∫–≥ (+30 000 —Å—É–º)</option>
            </select>
            <button onclick="go(3)">–î–∞–ª–µ–µ ‚û°Ô∏è</button>
            <button class="sec" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2 id="h-what">–ß—Ç–æ –≤–µ–∑–µ–º?</h2>
            <input type="text" id="inp-what" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...">
            <button onclick="go(4)">–í—ã–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç üìç</button>
            <button class="sec" onclick="handleBackToWeight()">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2 id="h-route">–ú–∞—Ä—à—Ä—É—Ç</h2>
            <button id="b-from" class="sec" onclick="openMapMode('from')">üìç –û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å</button>
            <button id="b-to" class="sec" onclick="openMapMode('to')">üèÅ –ö—É–¥–∞ –≤–µ–∑—Ç–∏</button>
            <div id="price-val" style="text-align:center; font-weight:900; color:var(--neon); font-size:24px; margin:15px;">7,000 UZS</div>
            <button id="btn-next4" style="display:none" onclick="showSummary()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚úÖ</button>
            <button class="sec" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step-map-confirm" class="step">
            <h2 id="h-instr">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</h2>
            <button onclick="confirmPoint()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="sec" onclick="go(4)">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div id="step5" class="step">
            <h2 id="h-fin">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            <div id="summary-data" class="summary-box"></div>
            <input type="text" id="user-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="tel" id="user-phone">
            <button onclick="finish()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–ö–ê–ó</button>
            <button class="sec" onclick="go(4)">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', what:'', weight:5, lat_from:0, lon_from:0, lat_to:0, lon_to:0, price:7000 };
        let map, mapMode = '', searchTimeout;

        const phoneMask = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([40.4897, 68.7848], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);
        }
        initMap();

        function applyLang(l) { order.lang = l; go(2); }
        function setCat(c) { order.type = c; if(c==='parcel') go('weight'); else go(3); }
        function handleBackToWeight() { if(order.type==='parcel') go('weight'); else go(2); }

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            let targetId = typeof s === 'string' ? 'step-'+s : 'step'+s;
            document.getElementById(targetId).classList.add('active');

            const isMap = (s === 'map-confirm');
            document.getElementById('search-box').style.display = isMap ? 'block' : 'none';
            document.getElementById('main-pin').style.display = isMap ? 'block' : 'none';
            document.getElementById('loc-btn').style.display = isMap ? 'block' : 'none';
        }

        function openMapMode(m) { mapMode = m; go('map-confirm'); }
        function locateMe() { map.locate({setView: true, maxZoom: 16}); }

        function confirmPoint() {
            let c = map.getCenter();
            if(mapMode === 'from') {
                order.lat_from = c.lat; order.lon_from = c.lng;
                document.getElementById('b-from').innerText = "‚úÖ –û–¢–ö–£–î–ê: –û–ö";
                document.getElementById('b-from').style.border = "1px solid var(--neon)";
            } else {
                order.lat_to = c.lat; order.lon_to = c.lng;
                document.getElementById('b-to').innerText = "‚úÖ –ö–£–î–ê: –û–ö";
                document.getElementById('b-to').style.border = "1px solid var(--neon)";
            }
            if(order.lat_from && order.lat_to) { calcPrice(); document.getElementById('btn-next4').style.display='flex'; }
            go(4);
        }

        function searchAddress(q) {
            clearTimeout(searchTimeout);
            if(q.length < 3) return;
            searchTimeout = setTimeout(() => {
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –ì—É–ª–∏—Å—Ç–∞–Ω–æ–º
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&viewbox=68.7,40.4,68.9,40.6&bounded=1&limit=5`)
                .then(r => r.json()).then(data => {
                    let res = document.getElementById('search-results');
                    res.innerHTML = '';
                    data.forEach(i => {
                        let d = document.createElement('div');
                        d.className = 'search-item';
                        d.innerText = i.display_name.split(',').slice(0,3).join(',');
                        d.onclick = () => { map.setView([i.lat, i.lon], 17); res.innerHTML = ''; };
                        res.appendChild(d);
                    });
                });
            }, 500);
        }

        function calcPrice() {
            if(!order.lat_from || !order.lat_to) return;
            let dist = L.latLng(order.lat_from, order.lon_from).distanceTo(L.latLng(order.lat_to, order.lon_to)) / 1000;
            let p = 7000 + (dist * 1800);
            let w = parseInt(document.getElementById('inp-weight').value || 5);
            if(order.type === 'parcel' && w > 5) p += (w-5)*2000;
            order.price = Math.round(p/500)*500;
            document.getElementById('price-val').innerText = order.price.toLocaleString() + " UZS";
        }

        function showSummary() {
            const isRu = order.lang === 'ru';
            document.getElementById('summary-data').innerHTML = `<b>${isRu?'–°—É–º–º–∞':'Narxi'}:</b> ${order.price.toLocaleString()} UZS<br><b>${isRu?'–ß—Ç–æ':'Nima'}:</b> ${document.getElementById('inp-what').value}`;
            go(5);
        }

        function finish() {
            order.name = document.getElementById('user-name').value;
            order.phone = phoneMask.value;
            order.what = document.getElementById('inp-what').value;
            if(!order.name || order.phone.length < 18) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!');
            tg.sendData(JSON.stringify(order));
        }
    </script>
</body>
</html>