<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --bg: #0f172a; --card: #1e293b; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: -apple-system, sans-serif; color: white; overflow: hidden; }

        #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; }
        #map { width: 100%; height: 100%; }

        .map-ui { position: absolute; z-index: 2100; width: 100%; pointer-events: none; }
        .map-ui * { pointer-events: auto; }
        .search-bar { top: 15px; padding: 0 15px; box-sizing: border-box; }
        .search-bar input { width: 100%; padding: 14px; border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 16px; }
        .center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); font-size: 40px; pointer-events: none; z-index: 2100; }
        .map-confirm-btn { bottom: 30px; padding: 0 20px; box-sizing: border-box; }

        .app-container { padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow-y: auto; }
        .step { display: none; }
        .step.active { display: block; }

        h2 { font-size: 22px; text-align: center; margin-bottom: 25px; }
        button { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 16px; font-weight: 700; margin-bottom: 12px; cursor: pointer; }
        .btn-main { background: var(--neon); color: black; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; }
        .btn-map { background: white; color: black; border: 1px solid #ddd; }

        input { width: 100%; padding: 16px; border-radius: 14px; border: 1px solid #334155; background: var(--card); color: white; margin-bottom: 12px; box-sizing: border-box; }
        .summary { background: var(--card); padding: 15px; border-radius: 15px; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="map-overlay">
        <div class="map-ui search-bar"><input type="text" id="map-search" placeholder="–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã..." oninput="smartSearch(this.value)"></div>
        <div class="center-pin">üìç</div>
        <div id="map"></div>
        <div class="map-ui map-confirm-btn">
            <button class="btn-main" onclick="confirmPoint()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –º–µ—Å—Ç–æ</button>
            <button class="btn-sec" onclick="closeMap()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="app-container">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –Ø–∑—ã–∫</h2>
            <button class="btn-main" onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="btn-main" onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2>–¢–∏–ø –∑–∞–∫–∞–∑–∞</h2>
            <button class="btn-main" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button class="btn-main" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="btn-sec" onclick="go(1)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2>–î–∞–Ω–Ω—ã–µ</h2>
            <input type="text" id="inp-what" placeholder="–ß—Ç–æ –≤–µ–∑–µ–º?">
            <input type="text" id="user-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="tel" id="user-phone">
            <div id="parcel-extra" style="display:none">
                <input type="text" id="rec-name" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
                <input type="tel" id="rec-phone">
            </div>
            <button class="btn-main" onclick="go(4)">–î–∞–ª–µ–µ</button>
            <button class="btn-sec" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2>–ú–∞—Ä—à—Ä—É—Ç</h2>
            <button id="b-from" class="btn-map" onclick="openMap('from')">üìç –û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å</button>
            <button id="b-to" class="btn-map" onclick="openMap('to')">üèÅ –ö—É–¥–∞ –≤–µ–∑—Ç–∏</button>
            <button id="btn-final" class="btn-main" style="display:none" onclick="showSummary()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button class="btn-sec" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step5" class="step">
            <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞</h2>
            <div id="summary-info" class="summary"></div>
            <button class="btn-main" onclick="sendToBot()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–ö–ê–ó</button>
            <button class="btn-sec" onclick="go(4)">–ò—Å–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', lat_from:null, lon_from:null, lat_to:null, lon_to:null, price:7000 };
        let map, mapMode = '';

        const m1 = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        const m2 = IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + s).classList.add('active');
        }

        function setLang(l) { order.lang = l; go(2); }
        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-extra').style.display = c === 'parcel' ? 'block' : 'none';
            go(3);
        }

        function openMap(mode) {
            mapMode = mode;
            document.getElementById('map-overlay').style.display = 'block';
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([40.4897, 68.7848], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            setTimeout(() => map.invalidateSize(), 200);
        }

        function closeMap() { document.getElementById('map-overlay').style.display = 'none'; }

        function confirmPoint() {
            let c = map.getCenter();
            if(mapMode === 'from') { order.lat_from = c.lat; order.lon_from = c.lng; document.getElementById('b-from').innerText = "‚úÖ –û—Ç–∫—É–¥–∞: OK"; }
            else { order.lat_to = c.lat; order.lon_to = c.lng; document.getElementById('b-to').innerText = "‚úÖ –ö—É–¥–∞: OK"; }
            if(order.lat_from && order.lat_to) document.getElementById('btn-final').style.display = 'block';
            closeMap();
        }

        function smartSearch(v) {
            if(v.length < 3) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=–ì—É–ª–∏—Å—Ç–∞–Ω ${v}&limit=1`)
            .then(r => r.json()).then(res => { if(res[0]) map.panTo([res[0].lat, res[0].lon]); });
        }

        function showSummary() {
            let info = `<b>–¢–∏–ø:</b> ${order.type}<br><b>–ß—Ç–æ:</b> ${document.getElementById('inp-what').value}<br><b>–ò–º—è:</b> ${document.getElementById('user-name').value}<br><b>–¢–µ–ª:</b> ${m1.value}`;
            document.getElementById('summary-info').innerHTML = info;
            go(5);
        }

        function sendToBot() {
            let data = {
                ...order,
                name: document.getElementById('user-name').value,
                phone: m1.value,
                what: document.getElementById('inp-what').value,
                rec_name: document.getElementById('rec-name').value || '-',
                rec_phone: m2.value || '-',
                price: 7000 // –ü–µ—Ä–µ–¥–∞–µ–º —Ü–µ–Ω—É —è–≤–Ω–æ
            };
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>