<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --dark: #0f172a; --yandex-light: #f3f3f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--dark); margin: 0; padding: 0; overflow: hidden; height: 100vh; }

        /* –°—Ç–∏–ª—å –∫–∞—Ä—Ç—ã –∫–∞–∫ –≤ Yandex Go (—Å–≤–µ—Ç–ª—ã–π –∏ —á–∏—Å—Ç—ã–π) */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; filter: grayscale(0.2); }

        /* –ü–æ–∏—Å–∫ –≤ —Å—Ç–∏–ª–µ Yandex */
        .search-box {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 90%; z-index: 2000; display: none;
        }
        .search-input {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 16px; background: white; color: black;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); outline: none;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ú–æ—è –ª–æ–∫–∞—Ü–∏—è" */
        .my-location-btn {
            position: absolute; right: 20px; bottom: 320px; z-index: 1500;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 24px;
        }

        /* –ü–∏–Ω –≤ —Ü–µ–Ω—Ç—Ä–µ (—Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å) */
        .center-pin {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%);
            z-index: 1500; pointer-events: none; display: none;
        }
        .pin-icon { font-size: 40px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ Mini App */
        .card {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; color: #1a1a1a; padding: 24px 20px 40px;
            border-radius: 28px 28px 0 0; z-index: 1000;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1); box-sizing: border-box;
            transition: 0.3s transform ease;
        }

        .step { display: none; }
        .step.active { display: block; }

        h2 { font-size: 20px; margin: 0 0 20px; text-align: center; font-weight: 700; }

        button {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            background: #333; color: white; font-weight: 600; font-size: 16px;
            margin: 8px 0; transition: 0.2s;
        }
        button.main-action { background: var(--neon); color: black; }
        button.secondary { background: var(--yandex-light); color: black; }

        input {
            width: 100%; padding: 16px; border-radius: 14px; border: 1px solid #e0e0e0;
            background: var(--yandex-light); color: black; margin-bottom: 12px;
            box-sizing: border-box; font-size: 16px;
        }

        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="search-box" id="search-container">
        <input type="text" class="search-input" id="addr-input" placeholder="–ö—É–¥–∞ –µ–¥–µ–º?" oninput="smartSearch(this.value)">
    </div>

    <div class="center-pin" id="pin">
        <div class="pin-icon">üìç</div>
    </div>

    <div class="my-location-btn" id="loc-btn" onclick="findMe()">üéØ</div>

    <div class="card" id="main-card">
        <div id="step1" class="step active">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Til tanlang</h2>
            <button class="main-action" onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="main-action" onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="h-cat">–ß—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ–º?</h2>
            <button class="main-action" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button class="main-action" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
        </div>

        <div id="step3" class="step">
            <h2 id="h-form">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
            <input type="text" id="inp-what" placeholder="–ß—Ç–æ –≤–µ–∑–µ–º?">
            <input type="text" id="user-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="tel" id="user-phone" placeholder="–í–∞—à –Ω–æ–º–µ—Ä">

            <div id="parcel-fields" style="display:none">
                <input type="text" id="rec-name" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
                <input type="tel" id="rec-phone" placeholder="–ù–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
            </div>

            <button class="main-action" onclick="toStep4()">–î–∞–ª–µ–µ ‚û°Ô∏è</button>
            <button class="secondary" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2 id="h-map-title">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å</h2>
            <button id="btn-from" class="secondary" onclick="modeMap('from')">üìç –û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å</button>
            <button id="btn-to" class="secondary" onclick="modeMap('to')">üèÅ –ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å</button>
            <button id="btn-confirm-all" style="display:none" class="main-action" onclick="toStep5()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>

        <div id="step-confirm-point" class="step">
            <h2>–î–≤–∏–≥–∞–π—Ç–µ –∫–∞—Ä—Ç—É</h2>
            <button class="main-action" onclick="savePoint()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç—É —Ç–æ—á–∫—É</button>
            <button class="secondary" onclick="go(4)">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div id="step5" class="step">
            <h2 id="h-finish">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h2>
            <div id="final-details"></div>
            <button class="main-action" onclick="submit()">üöÄ –í—Å–µ –≤–µ—Ä–Ω–æ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å!</button>
            <button class="secondary" onclick="go(3)">–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let order = { lang:'ru', type:'', lat_from:null, lat_to:null };
        let map, mapMode = '';

        // –ú–∞—Å–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
        const m1 = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        const m2 = IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        function initMap() {
            // –¶–µ–Ω—Ç—Ä –ì—É–ª–∏—Å—Ç–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ—Ç–ª—É—é –∫–∞—Ä—Ç—É CartoDB
            map = L.map('map', {zoomControl: false}).setView([40.4897, 68.7848], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬©OpenStreetMap'
            }).addTo(map);
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            let sid = (typeof s === 'string') ? 'step-'+s : 'step'+s;
            document.getElementById(sid).classList.add('active');

            // –í–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞—Ä—Ç—ã
            const isPointMode = (s === 'confirm-point');
            document.getElementById('pin').style.display = isPointMode ? 'block' : 'none';
            document.getElementById('search-container').style.display = isPointMode ? 'block' : 'none';
            document.getElementById('loc-btn').style.display = isPointMode ? 'block' : 'none';
        }

        function setLang(l) { order.lang = l; go(2); }
        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-fields').style.display = (c === 'parcel') ? 'block' : 'none';
            go(3);
        }

        function findMe() {
            map.locate({setView: true, maxZoom: 17});
        }

        function modeMap(m) { mapMode = m; go('confirm-point'); }

        function savePoint() {
            let center = map.getCenter();
            if(mapMode === 'from') {
                order.lat_from = center.lat; order.lon_from = center.lng;
                document.getElementById('btn-from').innerText = "‚úÖ –û—Ç–∫—É–¥–∞: –í—ã–±—Ä–∞–Ω–æ";
            } else {
                order.lat_to = center.lat; order.lon_to = center.lng;
                document.getElementById('btn-to').innerText = "‚úÖ –ö—É–¥–∞: –í—ã–±—Ä–∞–Ω–æ";
            }
            if(order.lat_from && order.lat_to) document.getElementById('btn-confirm-all').style.display = 'block';
            go(4);
        }

        function toStep4() {
            if(!document.getElementById('user-name').value || m1.value.length < 18) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω!");
            go(4);
        }

        function toStep5() {
            let html = `
                <div class="summary-row"><span>–¢–∏–ø:</span> <b>${order.type}</b></div>
                <div class="summary-row"><span>–ß—Ç–æ:</span> <b>${document.getElementById('inp-what').value}</b></div>
                <div class="summary-row"><span>–ö–ª–∏–µ–Ω—Ç:</span> <b>${document.getElementById('user-name').value}</b></div>
            `;
            document.getElementById('final-details').innerHTML = html;
            go(5);
        }

        function submit() {
            let data = {
                ...order,
                name: document.getElementById('user-name').value,
                phone: m1.value,
                what: document.getElementById('inp-what').value,
                rec_name: document.getElementById('rec-name').value || '-',
                rec_phone: m2.value || '-'
            };
            tg.sendData(JSON.stringify(data));
        }

        // –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ì—É–ª–∏—Å—Ç–∞–Ω—É
        function smartSearch(val) {
            if(val.length < 3) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=–ì—É–ª–∏—Å—Ç–∞–Ω ${val}&limit=1`)
            .then(r => r.json()).then(res => {
                if(res[0]) map.panTo([res[0].lat, res[0].lon]);
            });
        }

        initMap();
    </script>
</body>
</html>