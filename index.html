<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --bg: #0f172a; --card: #1e293b; }
        body, html { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: white; overflow-x: hidden; }
        .app-container { padding: 20px; box-sizing: border-box; min-height: 100vh; display: flex; flex-direction: column; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { font-size: 22px; text-align: center; margin-bottom: 20px; }
        button { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 16px; font-weight: 700; margin-bottom: 12px; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--neon); color: black; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; }
        .btn-loc { background: white; color: black; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; }

        input { width: 100%; padding: 16px; border-radius: 14px; border: 1px solid #334155; background: var(--card); color: white; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus { border-color: var(--neon); }
        .summary { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 20px; line-height: 1.5; border: 1px solid rgba(255,255,255,0.1); }

        /* –ö–∞—Ä—Ç–∞ */
        #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; }
        #map { width: 100%; height: 100%; }
        .center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); font-size: 40px; z-index: 2100; pointer-events: none; }
        .map-confirm { position: absolute; bottom: 30px; width: 100%; padding: 0 20px; box-sizing: border-box; z-index: 2100; }
    </style>
</head>
<body>

    <div id="map-overlay">
        <div class="center-pin">üìç</div>
        <div id="map"></div>
        <div class="map-confirm">
            <button class="btn-main" id="t-map-ok" onclick="confirmPoint()">OK</button>
        </div>
    </div>

    <div class="app-container">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
            <button class="btn-main" onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="btn-main" onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="t-cat">–ß—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ–º?</h2>
            <button class="btn-main" id="t-btn-parcel" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button class="btn-main" id="t-btn-food" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="btn-sec" id="t-back1" onclick="go(1)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2 id="t-form-title">–î–µ—Ç–∞–ª–∏</h2>
            <input type="text" id="inp-what">
            <input type="text" id="user-name">
            <input type="tel" id="user-phone">

            <div id="parcel-fields" style="display:none">
                <input type="text" id="rec-name">
                <input type="tel" id="rec-phone">
            </div>

            <div id="food-location" style="display:none">
                <button class="btn-loc" id="t-btn-loc" onclick="openMap()">üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
                <p id="loc-status" style="color:var(--neon); text-align:center; display:none; margin:0 0 10px; font-weight:bold;">‚úÖ OK</p>
            </div>

            <button class="btn-main" id="t-btn-next" onclick="toSummary()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <button class="btn-sec" id="t-back2" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2 id="t-check">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h2>
            <div id="summary-info" class="summary"></div>
            <button class="btn-main" id="t-btn-send" onclick="submitOrder()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button class="btn-sec" id="t-back3" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', lat:null, lon:null };
        let map;

        const m1 = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        const m2 = IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        const i18n = {
            ru: {
                cat: "–ß—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ–º?", parcel: "üì¶ –ü–æ—Å—ã–ª–∫–∞", food: "üõí –ü—Ä–æ–¥—É–∫—Ç—ã", back: "–ù–∞–∑–∞–¥",
                form: "–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞", what: "–ß—Ç–æ –ø—Ä–∏–≤–µ–∑—Ç–∏?", name: "–í–∞—à–µ –∏–º—è", rec_name: "–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è",
                loc: "üìç –£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏", check: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö", send: "üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑", ok: "–õ–æ–∫–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–∞"
            },
            uz: {
                cat: "Nima buyurtma berasiz?", parcel: "üì¶ Posilka", food: "üõí Mahsulotlar", back: "Orqaga",
                form: "Buyurtma tafsilotlari", what: "Nima olib kelish kerak?", name: "Ismingiz", rec_name: "Oluvchi ismi",
                loc: "üìç Yetkazib berish manzili", check: "Ma'lumotlarni tekshiring", send: "üöÄ Buyurtma berish", ok: "Manzil tanlandi"
            }
        };

        function setLang(l) {
            order.lang = l;
            const t = i18n[l];
            document.getElementById('t-cat').innerText = t.cat;
            document.getElementById('t-btn-parcel').innerText = t.parcel;
            document.getElementById('t-btn-food').innerText = t.food;
            document.querySelectorAll('[id^="t-back"]').forEach(b => b.innerText = t.back);
            document.getElementById('t-form-title').innerText = t.form;
            document.getElementById('inp-what').placeholder = t.what;
            document.getElementById('user-name').placeholder = t.name;
            document.getElementById('rec-name').placeholder = t.rec_name;
            document.getElementById('t-btn-loc').innerText = t.loc;
            document.getElementById('t-check').innerText = t.check;
            document.getElementById('t-btn-send').innerText = t.send;
            document.getElementById('loc-status').innerText = "‚úÖ " + t.ok;
            go(2);
        }

        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-fields').style.display = (c === 'parcel') ? 'block' : 'none';
            document.getElementById('food-location').style.display = (c === 'food') ? 'block' : 'none';
            go(3);
        }

        function openMap() {
            document.getElementById('map-overlay').style.display = 'block';
            if (!map) {
                map = L.map('map', {zoomControl: false}).setView([40.4897, 68.7848], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            setTimeout(() => map.invalidateSize(), 200);
        }

        function confirmPoint() {
            let c = map.getCenter();
            order.lat = c.lat; order.lon = c.lng;
            document.getElementById('map-overlay').style.display = 'none';
            document.getElementById('loc-status').style.display = 'block';
        }

        function toSummary() {
            const name = document.getElementById('user-name').value;
            if(!name || m1.value.length < 18) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
            if(order.type === 'food' && !order.lat) return alert("–£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é!");

            let text = `<b>${order.type === 'parcel' ? 'üì¶ Posilka' : 'üõí Mahsulot'}</b><br>` +
                       `üìù ${document.getElementById('inp-what').value}<br>` +
                       `üë§ ${name}<br>üìû ${m1.value}`;

            if(order.type === 'parcel') {
                text += `<br>üë§ Rec: ${document.getElementById('rec-name').value}<br>üìû ${m2.value}`;
            }

            document.getElementById('summary-info').innerHTML = text;
            go(4);
        }

        function submitOrder() {
            let data = {
                ...order,
                name: document.getElementById('user-name').value,
                phone: m1.value,
                what: document.getElementById('inp-what').value,
                rec_name: document.getElementById('rec-name').value || '-',
                rec_phone: m2.value || '-',
                price: 7000
            };
            tg.sendData(JSON.stringify(data));
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(e => e.classList.remove('active'));
            document.getElementById('step' + s).classList.add('active');
        }
    </script>
</body>
</html>