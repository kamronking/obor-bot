<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --dark: #0a0f1a; }
        body { font-family: -apple-system, sans-serif; background: var(--dark); color: white; margin: 0; padding: 0; overflow: hidden; height: 100vh; }
        .card { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 92%; max-width: 400px;
                background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; z-index: 10; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2 { text-align: center; color: var(--neon); text-transform: uppercase; margin: 0 0 20px 0; font-size: 20px; }
        button { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--neon); color: black; font-weight: bold; font-size: 16px; margin: 5px 0; cursor: pointer; }
        button.sec { background: #1e293b; color: white; }
        input, select { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 12px; box-sizing: border-box; outline: none; font-size: 16px; }
        #map-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--dark); }
        #map { width: 100%; height: 70%; }
        .map-bar { height: 30%; padding: 20px; background: var(--dark); box-sizing: border-box; text-align: center; }
        .price-badge { background: var(--neon); color: black; padding: 12px; border-radius: 12px; text-align: center; font-weight: 900; font-size: 20px; margin: 10px 0; }
        .marker-fixed { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -100%); z-index: 1000; font-size: 40px; pointer-events: none; }
    </style>
</head>
<body>

    <div class="card" id="main-card">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –Ø–∑—ã–∫</h2>
            <button onclick="applyLang('ru')">–†—É—Å—Å–∫–∏–π</button>
            <button onclick="applyLang('uz')">O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="h-cat">–¢–∏–ø –∑–∞–∫–∞–∑–∞</h2>
            <button id="btn-parcel" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button id="btn-food" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="sec" id="btn-back1" onclick="go(1)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step-weight" class="step">
            <h2 id="h-weight">–í–µ—Å –ø–æ—Å—ã–ª–∫–∏</h2>
            <select id="inp-weight" onchange="calcPrice()">
                <option value="1">–î–æ 5 –∫–≥ (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</option>
                <option value="6">6 –∫–≥ (+2 000 —Å—É–º)</option>
                <option value="7">7 –∫–≥ (+4 000 —Å—É–º)</option>
                <option value="8">8 –∫–≥ (+6 000 —Å—É–º)</option>
                <option value="9">9 –∫–≥ (+8 000 —Å—É–º)</option>
                <option value="10">10 –∫–≥ (+10 000 —Å—É–º)</option>
                <option value="15">15 –∫–≥ (+20 000 —Å—É–º)</option>
                <option value="20">20 –∫–≥ (+30 000 —Å—É–º)</option>
            </select>
            <button id="btn-next-w" onclick="go(3)">–î–∞–ª–µ–µ</button>
            <button class="sec" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2 id="h-what">–î–µ—Ç–∞–ª–∏</h2>
            <input type="text" id="inp-what">
            <button id="btn-next3" onclick="go(4)">–î–∞–ª–µ–µ</button>
            <button class="sec" id="btn-back2" onclick="handleBackToWeight()">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2 id="h-route">–ú–∞—Ä—à—Ä—É—Ç</h2>
            <button id="b-from" class="sec" onclick="openMap('from')">üìç –¢–æ—á–∫–∞ –ê (–û—Ç–∫—É–¥–∞)</button>
            <button id="b-to" class="sec" onclick="openMap('to')">üèÅ –¢–æ—á–∫–∞ –ë (–ö—É–¥–∞)</button>
            <div id="price-val" class="price-badge">7,000 UZS</div>
            <button id="btn-next4" style="display:none" onclick="go(5)">–î–∞–ª–µ–µ</button>
            <button class="sec" id="btn-back3" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step5" class="step">
            <h2 id="h-fin">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            <input type="text" id="user-name" oninput="validateName(this)">
            <input type="tel" id="user-phone">
            <button id="btn-order" onclick="finish()">üöÄ –ó–∞–∫–∞–∑–∞—Ç—å</button>
            <button class="sec" id="btn-back4" onclick="go(4)">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="map-ui">
        <div class="marker-fixed">üìç</div>
        <div id="map"></div>
        <div class="map-bar">
            <button id="btn-confirm" onclick="confirmLoc()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="sec" id="btn-cancel" onclick="closeMap()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', what:'', weight:1, lat_from:0, lon_from:0, lat_to:0, lon_to:0, price:7000 };
        let map, mapMode = '';

        const phoneMask = IMask(document.getElementById('user-phone'), {
            mask: '+{998} (00) 000-00-00',
            lazy: false
        });

        function validateName(input) {
            input.value = input.value.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å\s]/g, '');
        }

        const texts = {
            ru: {
                cat: "–¢–∏–ø –∑–∞–∫–∞–∑–∞", weight: "–í–µ—Å –ø–æ—Å—ã–ª–∫–∏", what: "–ß—Ç–æ –≤–µ–∑–µ–º?", route: "–ú–∞—Ä—à—Ä—É—Ç", fin: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
                parcel: "üì¶ –ü–æ—Å—ã–ª–∫–∞", food: "üõí –ü—Ä–æ–¥—É–∫—Ç—ã", back: "–ù–∞–∑–∞–¥", next: "–î–∞–ª–µ–µ", order: "üöÄ –ó–∞–∫–∞–∑–∞—Ç—å",
                name: "–í–∞—à–µ –∏–º—è (–±—É–∫–≤—ã)", placeholder: "–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª—é—á–∏", confirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", cancel: "–û—Ç–º–µ–Ω–∞"
            },
            uz: {
                cat: "Buyurtma turi", weight: "Posilka vazni", what: "Nima olib boramiz?", route: "Yo'nalish", fin: "Ma'lumotlar",
                parcel: "üì¶ Posilka", food: "üõí Mahsulotlar", back: "Orqaga", next: "Keyingisi", order: "üöÄ Buyurtma berish",
                name: "Ismingiz (harflar)", placeholder: "Masalan: Kalitlar", confirm: "Tasdiqlash", cancel: "Bekor qilish"
            }
        };

        function applyLang(l) {
            order.lang = l; const t = texts[l];
            document.getElementById('h-cat').innerText = t.cat;
            document.getElementById('h-weight').innerText = t.weight;
            document.getElementById('h-what').innerText = t.what;
            document.getElementById('h-route').innerText = t.route;
            document.getElementById('h-fin').innerText = t.fin;
            document.getElementById('btn-parcel').innerText = t.parcel;
            document.getElementById('btn-food').innerText = t.food;
            document.getElementById('inp-what').placeholder = t.placeholder;
            document.getElementById('user-name').placeholder = t.name;
            document.getElementById('btn-confirm').innerText = t.confirm;
            document.getElementById('btn-cancel').innerText = t.cancel;
            document.querySelectorAll("button.sec, #btn-back1, #btn-back2, #btn-back3, #btn-back4").forEach(b => b.innerText = t.back);
            document.querySelectorAll("#btn-next-w, #btn-next3, #btn-next4").forEach(b => b.innerText = t.next);
            document.getElementById('btn-order').innerText = t.order;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Å–∞ –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ
            const wSelect = document.getElementById('inp-weight');
            wSelect.options[0].text = l === 'ru' ? "–î–æ 5 –∫–≥ (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)" : "5 kg gacha (Bepul)";
            for(let i=1; i<wSelect.options.length; i++) {
                let kg = wSelect.options[i].value;
                let add = (kg - 5) * 2000;
                wSelect.options[i].text = `${kg} kg (+${add.toLocaleString()} sum)`;
            }

            go(2);
        }

        function setCat(c) {
            order.type = c;
            if(c === 'parcel') go('weight');
            else { order.weight = 0; go(3); }
        }

        function handleBackToWeight() {
            if(order.type === 'parcel') go('weight');
            else go(2);
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(typeof s === 'number' ? 'step'+s : 'step-'+s).classList.add('active');
        }

        function openMap(m) {
            mapMode = m; document.getElementById('map-ui').style.display = 'block';
            if(!map) {
                map = L.map('map').setView([40.48, 68.35], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            setTimeout(() => { map.invalidateSize(); }, 200);
            map.locate({setView: true, maxZoom: 16});
        }

        function closeMap() { document.getElementById('map-ui').style.display = 'none'; }

        function calcPrice() {
            if(!order.lat_from || !order.lat_to) return;

            let dist = L.latLng(order.lat_from, order.lon_from).distanceTo(L.latLng(order.lat_to, order.lon_to)) / 1000;
            let basePrice = 7000 + (dist * 1000);

            // –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –≤–µ—Å
            let weight = parseInt(document.getElementById('inp-weight').value);
            let weightSurcharge = 0;
            if(order.type === 'parcel' && weight > 5) {
                weightSurcharge = (weight - 5) * 2000;
            }

            order.price = Math.round(basePrice + weightSurcharge);
            document.getElementById('price-val').innerText = order.price.toLocaleString() + " UZS";
        }

        function confirmLoc() {
            let c = map.getCenter();
            if(mapMode === 'from') {
                order.lat_from = c.lat; order.lon_from = c.lng;
                document.getElementById('b-from').innerText = "‚úÖ " + (order.lang === 'ru' ? "–ê –≤—ã–±—Ä–∞–Ω–æ" : "A tanlandi");
            } else {
                order.lat_to = c.lat; order.lon_to = c.lng;
                document.getElementById('b-to').innerText = "‚úÖ " + (order.lang === 'ru' ? "–ë –≤—ã–±—Ä–∞–Ω–æ" : "B tanlandi");
            }
            if(order.lat_from && order.lat_to) {
                calcPrice();
                document.getElementById('btn-next4').style.display = 'block';
            }
            closeMap();
        }

        function finish() {
            const rawPhone = phoneMask.unmaskedValue;
            order.what = document.getElementById('inp-what').value;
            order.name = document.getElementById('user-name').value;
            order.phone = "+" + rawPhone;
            order.weight = document.getElementById('inp-weight').value;

            if(order.name.length < 2 || rawPhone.length < 12 || !order.what) {
                alert(order.lang === 'ru' ? "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!" : "Ma'lumotlarni to'ldiring!");
                return;
            }
            tg.sendData(JSON.stringify(order));
        }
    </script>
</body>
</html>