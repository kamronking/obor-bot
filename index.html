<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OBOR Delivery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        :root { --neon: #00e676; --bg: #0f172a; --card: #1e293b; --err: #ff5252; }
        body, html { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: white; height: 100vh; overflow: hidden; }
        .app-container { height: 100%; display: flex; flex-direction: column; box-sizing: border-box; }
        #step1 { display: none; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; }
        #step1.active { display: flex; }
        .step { display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .step.active:not(#step1) { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2 { font-size: 22px; text-align: center; margin-bottom: 25px; font-weight: 800; }
        button { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 16px; font-weight: 700; margin-bottom: 12px; cursor: pointer; }
        .btn-main { background: var(--neon); color: black; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; }
        input { width: 100%; padding: 16px; border-radius: 14px; border: 1px solid #334155; background: var(--card); color: white; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        input.invalid { border-color: var(--err); }
        .summary { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6; border: 1px solid rgba(255,255,255,0.1); }
        #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: #fff; }
        #map { width: 100%; height: 100%; }
        .gps-btn { position: absolute; bottom: 120px; right: 20px; z-index: 2200; background: white; color: black; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 26px; border: none; }
        .center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); font-size: 40px; z-index: 2100; pointer-events: none; }
        .map-confirm { position: absolute; bottom: 30px; width: 100%; padding: 0 20px; box-sizing: border-box; z-index: 2100; }
    </style>
</head>
<body>

    <div id="map-overlay">
        <button class="gps-btn" onclick="useGPS()">üéØ</button>
        <div class="center-pin">üìç</div>
        <div id="map"></div>
        <div class="map-confirm">
            <button class="btn-main" onclick="confirmPoint()">OK</button>
        </div>
    </div>

    <div class="app-container">
        <div id="step1" class="step active">
            <h2>Tilni tanlang / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
            <button class="btn-main" onclick="setLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="btn-main" onclick="setLang('uz')">üá∫üáø O'zbekcha</button>
        </div>

        <div id="step2" class="step">
            <h2 id="t-cat">–ß—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ–º?</h2>
            <button class="btn-main" id="t-btn-parcel" onclick="setCat('parcel')">üì¶ –ü–æ—Å—ã–ª–∫–∞</button>
            <button class="btn-main" id="t-btn-food" onclick="setCat('food')">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</button>
            <button class="btn-sec" id="t-back1" onclick="go(1)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step3" class="step">
            <h2 id="t-form-title">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
            <input type="text" id="inp-what">
            <input type="text" id="user-name">
            <input type="tel" id="user-phone">

            <div id="parcel-fields" style="display:none">
                <input type="text" id="rec-name">
                <input type="tel" id="rec-phone">
            </div>

            <div id="food-location" style="display:none">
                <button class="btn-sec" style="background:#fff; color:#000" id="t-btn-loc" onclick="openMap()">üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
                <p id="loc-status" style="color:var(--neon); text-align:center; display:none; margin:0 0 10px; font-weight:bold;">‚úÖ OK</p>
            </div>

            <button class="btn-main" id="t-btn-next" onclick="validateAndNext()">–î–∞–ª–µ–µ</button>
            <button class="btn-sec" id="t-back2" onclick="go(2)">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="step4" class="step">
            <h2 id="t-check">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h2>
            <div id="summary-info" class="summary"></div>
            <button class="btn-main" id="t-btn-send" onclick="submitOrder()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <button class="btn-sec" id="t-back3" onclick="go(3)">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let order = { lang:'ru', type:'', lat:null, lon:null };
        let map;

        const m1 = IMask(document.getElementById('user-phone'), { mask: '+{998} (00) 000-00-00' });
        const m2 = IMask(document.getElementById('rec-phone'), { mask: '+{998} (00) 000-00-00' });

        const i18n = {
            ru: {
                cat: "–ß—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ–º?", parcel: "üì¶ –ü–æ—Å—ã–ª–∫–∞", food: "üõí –ü—Ä–æ–¥—É–∫—Ç—ã", back: "–ù–∞–∑–∞–¥",
                form: "–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞", what: "–ß—Ç–æ –ø—Ä–∏–≤–µ–∑—Ç–∏?", name: "–í–∞—à–µ –∏–º—è", phone: "–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
                rec_name: "–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è", rec_phone: "–ù–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è",
                loc: "üìç –£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏", check: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö", send: "üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑",
                ok: "–õ–æ–∫–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–∞", next: "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", err_fill: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!"
            },
            uz: {
                cat: "Nima buyurtma berasiz?", parcel: "üì¶ Posilka", food: "üõí Mahsulotlar", back: "Orqaga",
                form: "Buyurtma tafsilotlari", what: "Nima olib kelish kerak?", name: "Ismingiz", phone: "Telefon raqamingiz",
                rec_name: "Oluvchi ismi", rec_phone: "Oluvchi telefoni",
                loc: "üìç Yetkazib berish manzili", check: "Ma'lumotlarni tekshiring", send: "üöÄ Buyurtma berish",
                ok: "Manzil tanlandi", next: "Rasmiylashtirish", err_fill: "Barcha maydonlarni to'ldiring!"
            }
        };

        function setLang(l) {
            order.lang = l;
            const t = i18n[l];
            document.getElementById('t-cat').innerText = t.cat;
            document.getElementById('t-btn-parcel').innerText = t.parcel;
            document.getElementById('t-btn-food').innerText = t.food;
            document.querySelectorAll('[id^="t-back"]').forEach(el => el.innerText = t.back);
            document.getElementById('t-form-title').innerText = t.form;
            document.getElementById('inp-what').placeholder = t.what;
            document.getElementById('user-name').placeholder = t.name;
            document.getElementById('user-phone').placeholder = t.phone;
            document.getElementById('rec-name').placeholder = t.rec_name;
            document.getElementById('rec-phone').placeholder = t.rec_phone;
            document.getElementById('t-btn-loc').innerText = t.loc;
            document.getElementById('t-check').innerText = t.check;
            document.getElementById('t-btn-send').innerText = t.send;
            document.getElementById('t-btn-next').innerText = t.next;
            document.getElementById('loc-status').innerText = "‚úÖ " + t.ok;
            go(2);
        }

        function setCat(c) {
            order.type = c;
            document.getElementById('parcel-fields').style.display = (c === 'parcel') ? 'block' : 'none';
            document.getElementById('food-location').style.display = (c === 'food') ? 'block' : 'none';
            go(3);
        }

        function validateAndNext() {
            const what = document.getElementById('inp-what');
            const name = document.getElementById('user-name');
            const phone = document.getElementById('user-phone');
            const recName = document.getElementById('rec-name');
            const recPhone = document.getElementById('rec-phone');

            let isValid = true;
            [what, name].forEach(el => {
                if(!el.value.trim()) { el.classList.add('invalid'); isValid = false; }
                else { el.classList.remove('invalid'); }
            });

            if(m1.value.length < 18) { phone.classList.add('invalid'); isValid = false; }
            else { phone.classList.remove('invalid'); }

            if(order.type === 'parcel') {
                if(!recName.value.trim()) { recName.classList.add('invalid'); isValid = false; }
                if(m2.value.length < 18) { recPhone.classList.add('invalid'); isValid = false; }
            }

            if(order.type === 'food' && !order.lat) {
                alert(i18n[order.lang].loc);
                isValid = false;
            }

            if(!isValid) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            toSummary();
        }

        function openMap() {
            document.getElementById('map-overlay').style.display = 'block';
            if (!map) {
                map = L.map('map', {zoomControl: false}).setView([40.4897, 68.7848], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            setTimeout(() => map.invalidateSize(), 200);
        }

        function useGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    map.setView([pos.coords.latitude, pos.coords.longitude], 17);
                }, () => alert("GPS error."));
            }
        }

        function confirmPoint() {
            let c = map.getCenter();
            order.lat = c.lat; order.lon = c.lng;
            document.getElementById('map-overlay').style.display = 'none';
            document.getElementById('loc-status').style.display = 'block';
        }

        function toSummary() {
            let typeName = order.lang === 'ru' ? (order.type === 'parcel' ? '–ü–æ—Å—ã–ª–∫–∞' : '–ü—Ä–æ–¥—É–∫—Ç—ã') : (order.type === 'parcel' ? 'Posilka' : 'Mahsulotlar');
            let text = `<b>${typeName}</b><br>` +
                       `üìù ${document.getElementById('inp-what').value}<br>` +
                       `üë§ ${document.getElementById('user-name').value}<br>` +
                       `üìû ${m1.value}`;
            document.getElementById('summary-info').innerHTML = text;
            go(4);
        }

        function submitOrder() {
            let data = {
                ...order,
                name: document.getElementById('user-name').value,
                phone: m1.value,
                what: document.getElementById('inp-what').value,
                rec_name: document.getElementById('rec-name').value || '-',
                rec_phone: m2.value || '-',
                price: 7000
            };
            tg.sendData(JSON.stringify(data));
        }

        function go(s) {
            document.querySelectorAll('.step').forEach(e => e.classList.remove('active'));
            document.getElementById('step' + s).classList.add('active');
        }
    </script>
</body>
</html>